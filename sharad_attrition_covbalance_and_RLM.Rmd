---
title: "sharad_rml"
author: "Sharad Varadarajan"
date: "August 14, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = normalizePath("./"))

library(MASS)
library(stargazer)
library(sandwich)
library(lmtest)

d = read.csv('1st_Launch_Full.csv')
```

```{r deduping}
library(data.table)
# Cleaning out incomplete responses before treament exposures
d <- d[!is.na(d$Track),]
#summary(d)
# Counting occurances of IP address and Geo-codes
d$geo_code <- paste(d$LocationLatitude, d$LocationLongitude)
dt = data.table(d)
dt[, `freq_geo` := .N, by = geo_code]
dt[, `freq_ip` := .N, by = IPAddress]
#class(as.data.frame(dt))
#dt
## Creatig 2 dedupped dataset, one with complete dedup where we do not allow any duplicates in IP or Geo code, and one where we exclude IP dupes, but allow up to 5 dups per geo code
complete_dedup<- dt[dt$freq_ip==1 & (dt$freq_geo == 1 | (dt$geo_code == 'NA NA' & Track!= ''))]
#nrow(complete_dedup)
five_or_less_dedup <- dt[dt$freq_ip==1 & dt$freq_geo<=5]
#nrow(five_or_less_dedup)
d<-complete_dedup



d$English_as_primary<-d[,.(abs(d$English_as_primary-2))]
d$English_as_primary<-as.factor(d$English_as_primary)
#Male: original, male=1, female=2
d$Male<-d[,.(abs(d$Male-2))]
d$Male<-as.factor(d$Male)
#household income- as factor due to <20k, >100k, and do not answer
d$Household_Income<-as.factor(d$Household_Income)

#Drink Frequency- options are not linear 
d$Drink_Frequency<-factor(d$Drink_Frequency)

#Cab preference
d$Cab_Preference<-d[,.(abs(d$Cab_Preference-2))]

#Purchase Frequency- also not linear
d$Purchase_Frequency<-factor(d$Purchase_Frequency)


d$same_format_origin<-rep(0,length(d$French_Purchasing_Page))
d[French_Purchasing_Page==1 & US_Origin==0,same_format_origin :=1]
d[German_Purchasing_Page==0 & French_Purchasing_Page==0 & US_Origin==1,same_format_origin :=1]
#French layout+french wine
d$French_format_wine<-rep(0,length(d$French_Purchasing_Page))
d[French_Purchasing_Page==1 & US_Origin==0,"French_format_wine" :=1]
#English layout + US wine
d$English_format_wine<-rep(0,length(d$French_Purchasing_Page))
d[German_Purchasing_Page==0 & French_Purchasing_Page==0 & US_Origin==1,"English_format_wine" :=1]

```

#Attrition
```{r} 
attrit = subset(d, Finished == 0)
sum(attrit$French_Purchasing_Page == 1)
sum(attrit$German_Purchasing_Page == 1)
sum(attrit$French_Purchasing_Page == 0 & attrit$German_Purchasing_Page == 0)

lm_attrit_format = lm(Finished~French_Purchasing_Page + German_Purchasing_Page, d)
lm_attrit_origin = lm(Finished~ US_Origin, d)
lm_attrit_descrip = lm(Finished~Long_Description, d)

## Logistic regression
LR_format <- glm (Finished ~ French_Purchasing_Page + German_Purchasing_Page, data=d, family = binomial)
LR_origin <- glm (Finished ~ US_Origin , data=d, family = binomial)
LR_descrip <- glm (Finished ~ Long_Description, data=d, family = binomial)

stargazer(lm_attrit_format,lm_attrit_origin,lm_attrit_descrip,LR_format, LR_origin, LR_descrip, title="Attrition Regressions", align=TRUE, type="text")
```
##Covariate Balance Check

**The p-value on the Fstats are insignificant for all covariate balance regression tests, meaning we cannot reject the null hypothesis that all coefficients are equal to 0**
```{r}

d$French_Purchasing_Page = as.numeric(as.character(d$French_Purchasing_Page))
d$German_Purchasing_Page = as.numeric(as.character(d$German_Purchasing_Page))
d$US_Origin = as.numeric(as.character(d$US_Origin))
d$Long_Description = as.numeric(as.character(d$Long_Description))

#French vs English format
French_cb = lm(French_Purchasing_Page ~ Male + Household_Income + English_as_primary + Drink_Frequency + Cab_Preference + Purchase_Frequency, data = d[d$German_Purchasing_Page != 1,])

#German vs English format
German_cb = lm(German_Purchasing_Page ~ Male + Household_Income + English_as_primary + Drink_Frequency + Cab_Preference + Purchase_Frequency, data = d[d$French_Purchasing_Page != 1,])

#French vs German format
French_German_cb = lm(French_Purchasing_Page ~ Male + Household_Income + English_as_primary + Drink_Frequency + Cab_Preference + Purchase_Frequency, data = d[d$French_Purchasing_Page == 1 | d$German_Purchasing_Page == 1 ,])

#US Origin vs French Origin
Origin_cb = lm(US_Origin ~ Male + Household_Income + English_as_primary + Drink_Frequency + Cab_Preference + Purchase_Frequency, data = d)

#Long Description vs Short Description
LD_cb = lm(Long_Description ~ Male + Household_Income + English_as_primary + Drink_Frequency + Cab_Preference + Purchase_Frequency, data = d)

stargazer(French_cb,German_cb,French_German_cb,LD_cb, Origin_cb, title ="Covariate Balance Regressions", align=TRUE, type="text",font.size= "scriptsize", column.sep.width = "0.5pt")


```

#GUESS THE PRICE

```{r}
d$French_Purchasing_Page<-factor(d$French_Purchasing_Page)
d$German_Purchasing_Page<-factor(d$German_Purchasing_Page)
d$US_Origin <- factor(d$US_Origin)
d$Long_Description <- factor(d$Long_Description)

d$Male = as.character(d$Male)
d$Household_Income = as.character(d$Household_Income)
d$Cab_Preference = as.character(d$Cab_Preference)
d$English_as_primary = as.character(d$English_as_primary)
d$Drink_Frequency = as.character(d$Drink_Frequency)
d$Purchase_Frequency = as.character(d$Purchase_Frequency)

```

#Individual Treatments- RLM regressions with no covariates

**No statistical significance in treatments**
```{r}
rlm.format<-rlm(Guess_the_Cost~French_Purchasing_Page + German_Purchasing_Page, d)
rlm.origin<-rlm(Guess_the_Cost~US_Origin,d)
rlm.description<-rlm(Guess_the_Cost~Long_Description,d)
rlm.combined<-rlm(Guess_the_Cost~French_Purchasing_Page + German_Purchasing_Page + US_Origin + Long_Description,d)


stargazer(rlm.combined,rlm.format,rlm.origin,rlm.description,title="RLM Basic regressions- no covariates", align=TRUE, type="text")
```

#Individual Treatments- RLM regressions with covariates

**No statistical significance in treatments**
```{r}

rlm.cv<-rlm(Guess_the_Cost~French_Purchasing_Page + German_Purchasing_Page + US_Origin + Long_Description +  Male + Household_Income + English_as_primary  + Drink_Frequency + Cab_Preference + Purchase_Frequency, d)

rlm.cv1<-rlm(Guess_the_Cost~French_Purchasing_Page + German_Purchasing_Page + Male + Household_Income + English_as_primary  + Drink_Frequency + Cab_Preference + Purchase_Frequency, d)

rlm.cv2 <- rlm(Guess_the_Cost~ US_Origin + Male + Household_Income + English_as_primary  + Drink_Frequency + Cab_Preference + Purchase_Frequency,d)

rlm.cv3 <- rlm(Guess_the_Cost~ Long_Description + Male + Household_Income + English_as_primary  + Drink_Frequency + Cab_Preference + Purchase_Frequency,d)

stargazer(rlm.cv, rlm.cv1, rlm.cv2, rlm.cv3, align=TRUE,type="text", title = "RLM Basic regressions- with covariates")
```

#Saturated

**No statistical significance for treatments**
```{r}
d$Track<-factor(d$Track)

rlm.saturated<-rlm(Guess_the_Cost~ Track + Male + Household_Income + English_as_primary + Drink_Frequency + Cab_Preference + Purchase_Frequency,d)

stargazer(rlm.saturated, align=TRUE,type="text", title = "RLM regressions- saturated")
```

#Full Interactions without covariates

**Statistical Significance at the 10% level for Long Description**

```{r}
rlm.interactions<-rlm(Guess_the_Cost~ French_Purchasing_Page + German_Purchasing_Page + US_Origin + Long_Description + French_Purchasing_Page * US_Origin + German_Purchasing_Page * US_Origin + French_Purchasing_Page * Long_Description + German_Purchasing_Page * Long_Description + US_Origin * Long_Description + French_Purchasing_Page * US_Origin * Long_Description + German_Purchasing_Page* US_Origin * Long_Description,d)

stargazer(rlm.interactions, align=TRUE,type="text", title = "RLM regression- with interactions")
```


#Interaction Pairs without covariates

#Statistical Significance at the 5% level for Long Description (regression without language format)
#Statistical Significance at the 10% level for interaction term Long Description with US Origin (regression without language format)
```{r}
rlm.i1<-rlm(Guess_the_Cost~ French_Purchasing_Page + German_Purchasing_Page + US_Origin + French_Purchasing_Page * US_Origin + German_Purchasing_Page * US_Origin,d)

rlm.i2<-rlm(Guess_the_Cost~ French_Purchasing_Page + German_Purchasing_Page + Long_Description + French_Purchasing_Page * Long_Description + German_Purchasing_Page * Long_Description,d)

rlm.i3<- rlm(Guess_the_Cost~ US_Origin + Long_Description + US_Origin * Long_Description, d)

stargazer(rlm.i1, rlm.i2, rlm.i3, align=TRUE,type="text", title = "RLM regression- with interactions")
```

##Interaction Pairs with covariates

#Statistical Significance at the 10% level for Long Description (regression without language format)
#Statistical Significance at the 10% level for interaction term Long Description with US Origin (regression without language format)

```{r}
rlm.i1<-rlm(Guess_the_Cost~ French_Purchasing_Page + German_Purchasing_Page + US_Origin + French_Purchasing_Page * US_Origin + German_Purchasing_Page * US_Origin + Male + Household_Income + English_as_primary + Drink_Frequency + Cab_Preference + Purchase_Frequency,d)

rlm.i2<-rlm(Guess_the_Cost~ French_Purchasing_Page + German_Purchasing_Page + Long_Description + French_Purchasing_Page * Long_Description + German_Purchasing_Page * Long_Description + Male + Household_Income + English_as_primary + Drink_Frequency + Cab_Preference + Purchase_Frequency,d)

rlm.i3<- rlm(Guess_the_Cost~ US_Origin + Long_Description + US_Origin * Long_Description + Male + Household_Income + English_as_primary + Drink_Frequency + Cab_Preference + Purchase_Frequency, d)

stargazer(rlm.i1, rlm.i2, rlm.i3, align=TRUE,type="text", title = "RLM regression- with interactions")
```

#Interactions - Same Format/Origin without covariates
**No statistical significance for treatment**
```{r}
#models
rlm.same<-rlm(Guess_the_Cost ~ same_format_origin, d)
#summary(lm.same)

rlm.same_indiv<-rlm(Guess_the_Cost ~ French_format_wine + English_format_wine, d)

stargazer(rlm.same,rlm.same_indiv,align=TRUE,type="text")
```



#Interactions - Same Format/Origin with covariates
**No statistical significance for treatment**
```{r}
#models
rlm.same<-rlm(Guess_the_Cost ~ same_format_origin + Male + Household_Income + English_as_primary + Drink_Frequency + Cab_Preference + Purchase_Frequency ,d)
#summary(lm.same)

rlm.same_indiv<-rlm(Guess_the_Cost ~ French_format_wine + English_format_wine + Male + Household_Income + English_as_primary + Drink_Frequency + Cab_Preference + Purchase_Frequency,d)

stargazer(rlm.same,rlm.same_indiv,align=TRUE,type="text")
```


#Fully Saturated
**No statistical significance for treatment**
```{r}
rlm.fully_sat<-rlm(Guess_the_Cost~ French_Purchasing_Page + German_Purchasing_Page + US_Origin + Long_Description + French_Purchasing_Page * US_Origin + German_Purchasing_Page * US_Origin + French_Purchasing_Page * Long_Description + German_Purchasing_Page * Long_Description + US_Origin * Long_Description + French_Purchasing_Page * US_Origin * Long_Description + German_Purchasing_Page* US_Origin * Long_Description + Male + Household_Income + English_as_primary + Drink_Frequency + Cab_Preference + Purchase_Frequency,d)

stargazer(rlm.fully_sat, align=TRUE,type="text", title = "RLM regression- with interactions")
```

